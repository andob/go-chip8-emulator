#include <Arduino.h>
#include <avr/pgmspace.h>
#include "system.h"

#define baudRate 9600

//todo remove hardcoded ROM
#define ibmLogoSize 340
const uint8_t ibmLogo[ibmLogoSize] PROGMEM = {
    0x00, 0xe0, 0xa2, 0x2a,
    0x60, 0x0c, 0x61, 0x08,
    0xd0, 0x1f, 0x70, 0x09,
    0xa2, 0x39, 0xd0, 0x1f,
    0xa2, 0x48, 0x70, 0x08,
    0xd0, 0x1f, 0x70, 0x04,
    0xa2, 0x57, 0xd0, 0x1f,
    0x70, 0x08, 0xa2, 0x66,
    0xd0, 0x1f, 0x70, 0x08,
    0xa2, 0x75, 0xd0, 0x1f,
    0x12, 0x28, 0xff, 0x00,
    0xff, 0x00, 0x3c, 0x00,
    0x3c, 0x00, 0x3c, 0x00,
    0x3c, 0x00, 0xff, 0x00,
    0xff, 0xff, 0x00, 0xff,
    0x00, 0x38, 0x00, 0x3f,
    0x00, 0x3f, 0x00, 0x38,
    0x00, 0xff, 0x00, 0xff,
    0x80, 0x00, 0xe0, 0x00,
    0xe0, 0x00, 0x80, 0x00,
    0x80, 0x00, 0xe0, 0x00,
    0xe0, 0x00, 0x80, 0xf8,
    0x00, 0xfc, 0x00, 0x3e,
    0x00, 0x3f, 0x00, 0x3b,
    0x00, 0x39, 0x00, 0xf8,
    0x00, 0xf8, 0x03, 0x00,
    0x07, 0x00, 0x0f, 0x00,
    0xbf, 0x00, 0xfb, 0x00,
    0xf3, 0x00, 0xe3, 0x00,
    0x43, 0xe0, 0x00, 0xe0,
    0x00, 0x80, 0x00, 0x80,
    0x00, 0x80, 0x00, 0x80,
    0x00, 0xe0, 0x00, 0xe0
};

System chip8System(ibmLogo, ibmLogoSize);

extern int __heap_start, *__brkval;

int getFreeRAM() {
    int v;
    return (int)&v - (__brkval == 0 ? (int)&__heap_start : (int)__brkval);
}

void setup() {
    randomSeed(analogRead(A0));

    Serial.begin(baudRate);
}

//todo implement menu
//todo implement LCD frontend
//todo implement joystick
//todo implement buzzer (on soundTimer)
void loop() {
    unsigned long startTime = millis();
    chip8System.vblank();
    unsigned long stopTime = millis();

    Serial.print("Delta time: ");
    Serial.print(stopTime - startTime);
    Serial.print(" Consumed RAM: ");
    Serial.print(getFreeRAM());
    Serial.print('\n');
}
